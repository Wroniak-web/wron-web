name: Parse Jobs Daily

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00 UTC (4:00 Ð¿Ð¾ Ð¿Ð¾Ð»ÑŒÑÐºÐ¾Ð¼Ñƒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸)
    - cron: '0 2 * * *'
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  push:
    paths:
      - 'scripts/**'
      - 'parsers/**'
      - '.github/workflows/parse-jobs.yml'

permissions:
  contents: write # ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹

jobs:
  parse-jobs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install dependencies
        run: |
          npm ci
          
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf
          
      - name: Parse jobs
        run: |
          npm run parse
          
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/data/
          git commit -m "ðŸ¤– Auto-update jobs data - $(date '+%Y-%m-%d %H:%M')" || exit 0
          git push origin main
          
      - name: Create summary
        run: |
          echo "## ðŸ“Š Jobs Parsing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.verify-changed-files.outputs.changed == 'true' && 'âœ… Updated' || 'â„¹ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/all-jobs.json" ]; then
            TOTAL_JOBS=$(cat data/all-jobs.json | jq '.totalCount // 0')
            echo "**Total jobs:** $TOTAL_JOBS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sources:" >> $GITHUB_STEP_SUMMARY
          for file in data/*-jobs.json; do
            if [ -f "$file" ]; then
              SOURCE=$(basename "$file" -jobs.json)
              COUNT=$(cat "$file" | jq '.count // 0')
              echo "- **$SOURCE:** $COUNT jobs" >> $GITHUB_STEP_SUMMARY
            fi
          done
